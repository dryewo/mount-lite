<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Reloading defstates</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Mount-lite</span> <span class="project-version">0.9.7</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="01-basics.html"><div class="inner"><span>The basics</span></div></a></li><li class="depth-1 "><a href="02-substitutions.html"><div class="inner"><span>Substitutions</span></div></a></li><li class="depth-1 "><a href="03-start-stop-options.html"><div class="inner"><span>Start/stop options</span></div></a></li><li class="depth-1  current"><a href="04-reloading.html"><div class="inner"><span>Reloading defstates</span></div></a></li><li class="depth-1 "><a href="05-parallelism.html"><div class="inner"><span>Parallelism</span></div></a></li><li class="depth-1 "><a href="06-bindings.html"><div class="inner"><span>Bindings</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mount</span></div></div></li><li class="depth-2"><a href="mount.lite.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lite</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#reloading-defstates" name="reloading-defstates"></a>Reloading defstates</h1>
<p>A library like mount-lite is developed for developing applications quickly, working nicely together with a REPL. Reloading namespaces (or parts thereof) often helps a great deal. Whenever you reload, you don&rsquo;t want any old state hanging around. The mount-lite library is great for reloading parts of your application often.</p>
<h2><a href="#default-reloading-behaviour" name="default-reloading-behaviour"></a>Default reloading behaviour</h2>
<p>Whenever you redefine a defstate var, by default that defstate <em>and</em> all the states depending on that state will be stopped automatically (in reverse order). We call this a cascading stop, and uses an internal graph to determine the dependents. For example:</p>
<pre><code class="clj">(defstate a :start nil :stop (println &quot;Stopping a&quot;))
(defstate b :start nil :stop (println &quot;Stopping b&quot;))
(defstate c :start nil :stop (println &quot;Stopping c&quot;))

(start)
;=&gt; (#&#39;user/a #&#39;user/b #&#39;user/c)

(defstate b :start nil :stop (println &quot;Different stop b&quot;))
;;&gt; Stopping c
;;&gt; Stopping b

(start)
;=&gt; (#&#39;user/b #&#39;user/c)
</code></pre>
<p>Note how the the <code>#&#39;user/c</code> defstate var has been stopped automatically as well, as it depends on the redefined <code>#&#39;user/b</code> defstate. Also note that the <code>:stop</code> expression from <code>#&#39;user/b</code> is used from the definition as it was started.</p>
<p>This cascading is great to work with, and in combination with the <a href="https://github.com/clojure/tools.namespace">tools.namespace</a> library it can really shine. Whenever you make sure your namespaces with <code>defstate</code> definitions have <code>{:clojure.tools.namespace.repl/unload false}</code> as metadata, calling <code>(clojure.tools.namespace.repl/refresh :after &#39;mount.lite/start)</code> will only stop the required states (in correct order) and restart them.</p>
<blockquote>
  <p>NOTE: If you want your namespaces to be unloaded when using <code>c.t.n.r/refresh</code>, i.e. not including the mentioned metadata, make sure you call <code>(stop)</code> beforehand.</p>
  <p>NOTE: This cascading behaviour is actually implemented using the <code>:up-to</code> option, as described in the section about start/stop options.</p>
</blockquote>
<h2><a href="#overriding-the-default" name="overriding-the-default"></a>Overriding the default</h2>
<p>While this cascading stop is what you want most of the times, there may be situations where you don&rsquo;t want this reloading and/or cascading stop behaviour.</p>
<h3><a href="#the-on-reload-option" name="the-on-reload-option"></a>The :on-reload option</h3>
<p>To alter the reloading behaviour, one can set a different mode via the <code>:on-reload</code> option on a <code>defstate</code>. You can set the option to one the following modes:</p>
<ul>
  <li>
  <p><code>:cascade</code> - This is the default, as described above.</p></li>
  <li>
  <p><code>:stop</code> - This will stop only the state that is being redefined.</p></li>
  <li>
  <p><code>:lifecycle</code> - This will only redefine the lifecycle functions, and keep the state running as is (including the accompanying <code>:stop</code> expression). I.e, it is only after a (re)start that the redefinition will be used.</p></li>
</ul>
<h3><a href="#the-on-cascade-option" name="the-on-cascade-option"></a>The :on-cascade option</h3>
<p>If you don&rsquo;t want your <code>defstate</code> to be stopped whenever a dependency is stopped because it is redefined, you can have your defstate skip the cascading stop with the <code>:on-cascade</code> option on your <code>defstate</code>. If you set this to <code>:skip</code>, the defstate won&rsquo;t be stopped automatically whenever a dependency is redefined that has <code>:cascade</code> as its <code>:on-reload</code> behaviour.</p>
<blockquote>
  <p>NOTE: You can also override the <code>:on-reload</code> behaviour of all the <code>defstates</code> by setting a behaviour using the <code>on-reload</code> function. By setting is back to <code>nil</code>, the <code>:on-reload</code> setting of the <code>defstates</code> is used again.</p>
</blockquote></div></div></div></body></html>